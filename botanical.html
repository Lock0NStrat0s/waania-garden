<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Waania's Botanical Lab</title>
    <style>
      /* --- BASE STYLES --- */
      body {
        margin: 0;
        overflow: hidden;
        background: #111;
        font-family: system-ui, -apple-system, sans-serif;
      }
      canvas {
        display: block;
      }

      /* --- UI CONTAINER (Glassmorphism) --- */
      #ui-container {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 300px;
        max-width: 80%;
        background: rgba(20, 20, 35, 0.85); /* Dark Blue Glass */
        backdrop-filter: blur(10px);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        padding: 20px;
        transition: transform 0.3s ease, opacity 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 10;
      }

      /* Hiding the panel slides it down and fades it */
      #ui-container.hidden {
        transform: translateY(150%);
        opacity: 0;
        pointer-events: none;
      }

      /* --- HEADER & TOGGLE --- */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }
      h1 {
        margin: 0;
        font-size: 1rem;
        color: white;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
      }

      /* Close Button (X) */
      .close-btn {
        background: none;
        border: none;
        color: #666;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px;
      }
      .close-btn:hover {
        color: white;
      }

      /* --- SHOW BUTTON (Floating Icon) --- */
      #show-ui-btn {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(20, 20, 35, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 12px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 5; /* Below the main panel */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }
      #show-ui-btn:active {
        transform: scale(0.9);
      }

      /* --- INPUT ROWS --- */
      .control-row {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: #ccc;
      }

      /* SYNCED INPUTS */
      .input-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* The Slider */
      input[type="range"] {
        flex-grow: 1; /* Takes up remaining space */
        accent-color: #ff0066;
        cursor: pointer;
      }

      /* The Number Box */
      input[type="number"] {
        width: 50px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        color: white;
        padding: 4px;
        font-size: 0.9rem;
        text-align: center;
      }
      /* Remove arrows from number input */
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
      }

      /* Color Picker */
      input[type="color"] {
        width: 100%;
        height: 35px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background: none;
      }

      /* --- SNAP BUTTON (Bottom Right) --- */
      #saveBtn {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: white;
        color: #1a1a2e;
        border: none;
        padding: 15px 25px;
        border-radius: 30px;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        z-index: 100;
        transition: transform 0.2s;
      }
      #saveBtn:active {
        transform: scale(0.95);
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
        }
      }
    </script>
  </head>
  <body>
    <button id="show-ui-btn" title="Open Controls">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <line x1="4" y1="21" x2="4" y2="14"></line>
        <line x1="4" y1="10" x2="4" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12" y2="3"></line>
        <line x1="20" y1="21" x2="20" y2="16"></line>
        <line x1="20" y1="12" x2="20" y2="3"></line>
        <line x1="1" y1="14" x2="7" y2="14"></line>
        <line x1="9" y1="8" x2="15" y2="8"></line>
        <line x1="17" y1="16" x2="23" y2="16"></line>
      </svg>
    </button>

    <div id="ui-container">
      <div class="header">
        <h1>Botanical Lab</h1>
        <button class="close-btn" id="hide-ui-btn">âœ•</button>
      </div>

      <div class="control-row">
        <div class="label-row"><label>Petal Count</label></div>
        <div class="input-group">
          <input type="range" id="petalCount" min="3" max="50" value="12" />
          <input type="number" id="petalCountNum" value="12" min="3" max="50" />
        </div>
      </div>

      <div class="control-row">
        <div class="label-row"><label>Bloom Stage</label></div>
        <div class="input-group">
          <input
            type="range"
            id="bloomRadius"
            min="0"
            max="1.5"
            step="0.1"
            value="0.5"
          />
          <input type="number" id="bloomRadiusNum" value="0.5" step="0.1" />
        </div>
      </div>

      <div class="control-row">
        <div class="label-row"><label>Petal Length</label></div>
        <div class="input-group">
          <input
            type="range"
            id="petalLength"
            min="1"
            max="8"
            step="0.1"
            value="4"
          />
          <input type="number" id="petalLengthNum" value="4" step="0.1" />
        </div>
      </div>

      <div class="control-row">
        <div class="label-row"><label>Petal Width</label></div>
        <div class="input-group">
          <input
            type="range"
            id="petalWidth"
            min="0.1"
            max="2"
            step="0.1"
            value="1"
          />
          <input type="number" id="petalWidthNum" value="1" step="0.1" />
        </div>
      </div>

      <div class="control-row">
        <div class="label-row"><label>Pigment</label></div>
        <input type="color" id="petalColor" value="#ff0066" />
      </div>
    </div>

    <button id="saveBtn">ðŸ“¸ Snap</button>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";

      // --- SETUP ---
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a1a2e);
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(0, 5, 15);

      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        preserveDrawingBuffer: true,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // Lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      const pointLight = new THREE.PointLight(0xffffff, 1.5, 100);
      pointLight.position.set(10, 10, 10);
      scene.add(pointLight);

      // Controls
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      //controls.autoRotate = true;
      //controls.autoRotateSpeed = 1.0;

      // --- FLOWER ENGINE ---
      const flowerGroup = new THREE.Group();
      flowerGroup.position.y = 2; // Center visual
      scene.add(flowerGroup);

      // Shared Geometries (Optimization)
      const thornGeometry = new THREE.ConeGeometry(0.08, 0.4, 8);
      thornGeometry.translate(0, 0.2, 0); // Pivot adjustment

      const petalGeometry = new THREE.SphereGeometry(0.5, 32, 16);
      petalGeometry.translate(0, 0.5, 0); // Pivot adjustment

      const stemPath = new THREE.CatmullRomCurve3([
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(0.5, -4, 0),
        new THREE.Vector3(0, -8, 0),
      ]);
      const stemGeometry = new THREE.TubeGeometry(stemPath, 20, 0.15, 8, false);

      const baseMaterial = new THREE.MeshPhongMaterial({
        shininess: 100,
        side: THREE.DoubleSide,
      });
      const stemMaterial = new THREE.MeshPhongMaterial({
        color: 0x339933,
        shininess: 10,
        flatShading: true,
      });

      function generateFlower() {
        // Cleanup
        flowerGroup.children.forEach((c) => {
          if (c.geometry) c.geometry.dispose();
        });
        flowerGroup.clear();

        // 1. Get Values (From Sliders)
        // Note: The sliders and number boxes are synced, so we can just read the slider
        const count = parseInt(document.getElementById("petalCount").value);
        const bloom = parseFloat(document.getElementById("bloomRadius").value);
        const len = parseFloat(document.getElementById("petalLength").value);
        const wid = parseFloat(document.getElementById("petalWidth").value);
        const colorVal = document.getElementById("petalColor").value;

        // 2. Build Stem
        flowerGroup.add(new THREE.Mesh(stemGeometry, stemMaterial));

        // --- 2.5 ADD THORNS & LEAVES ---
        // We will walk down the stem path and randomly place items
        const stemLength = 20; // Number of steps down the stem

        for (let i = 1; i < stemLength - 1; i++) {
          // "t" is a value from 0 (top) to 1 (bottom)
          const t = i / stemLength;
          const point = stemPath.getPointAt(t); // Get (x,y,z) on curve
          const tangent = stemPath.getTangentAt(t); // Get direction of curve

          // A. THORNS (Random chance: 20%)
          if (Math.random() < 0.2) {
            const thorn = new THREE.Mesh(thornGeometry, stemMaterial);

            thorn.position.copy(point);

            // Math to make thorn point OUTWARD from stem
            // We use a random rotation around the stem axis
            thorn.quaternion.setFromUnitVectors(
              new THREE.Vector3(0, 1, 0),
              tangent
            );
            thorn.rotateX(Math.PI / 2); // Point out
            thorn.rotateZ(Math.random() * Math.PI * 2); // Random direction

            flowerGroup.add(thorn);
          }

          // B. STEM LEAVES (Random chance: 15%)
          // Don't put leaves too close to the flower head (t > 0.3)
          if (t > 0.3 && Math.random() < 0.15) {
            const leaf = new THREE.Mesh(petalGeometry, stemMaterial);

            // Shape: Short, fat, and flat
            leaf.scale.set(0.5, 1.5, 0.05);

            leaf.position.copy(point);

            // Orientation
            leaf.quaternion.setFromUnitVectors(
              new THREE.Vector3(0, 1, 0),
              tangent
            );
            leaf.rotateX(Math.PI / 2);
            leaf.rotateZ(Math.random() * Math.PI * 2);

            flowerGroup.add(leaf);
          }
        }

        // 3. Build Sepals
        for (let i = 0; i < 3; i++) {
          const p = new THREE.Object3D();
          p.rotation.z = (i / 5) * (Math.PI * 2);
          const s = new THREE.Mesh(petalGeometry, stemMaterial);
          s.scale.set(0.6 * wid, 4, 0.1); // Sepals don't stretch as much
          s.rotation.x = -2.0;
          s.position.y = -0.2;
          p.add(s);
          flowerGroup.add(p);
        }

        // 4. Build Petals
        const rings = 4;
        for (let i = 0; i < count; i++) {
          for (let r = 0; r < rings; r++) {
            const pivot = new THREE.Object3D();
            const angle = (i / count) * (Math.PI * 2);
            pivot.rotation.z = angle + r * 0.5; // Stagger

            // Color Logic
            const mat = baseMaterial.clone();
            const col = new THREE.Color(colorVal);
            const hsl = {};
            col.getHSL(hsl);
            mat.color.setHSL(hsl.h, hsl.s, hsl.l + (r * 0.1 - 0.1));

            const petal = new THREE.Mesh(petalGeometry, mat);
            petal.rotation.x = bloom + r * 0.3;

            // PARAMETRIC SCALING
            const scale = 1 - r * 0.25;
            petal.scale.set(scale * wid, scale * len, scale * 0.1);

            pivot.add(petal);
            flowerGroup.add(pivot);
          }
        }
      }

      // --- UI LOGIC (Syncing & Toggling) ---

      // Helper to sync Slider <-> Number Box
      function bindInput(sliderId, numberId) {
        const slider = document.getElementById(sliderId);
        const number = document.getElementById(numberId);

        // Slide -> Update Number & Regen
        slider.addEventListener("input", () => {
          number.value = slider.value;
          generateFlower();
        });

        // Type Number -> Update Slider & Regen
        number.addEventListener("input", () => {
          slider.value = number.value;
          generateFlower();
        });
      }

      // Bind all pairs
      bindInput("petalCount", "petalCountNum");
      bindInput("bloomRadius", "bloomRadiusNum");
      bindInput("petalLength", "petalLengthNum");
      bindInput("petalWidth", "petalWidthNum");

      // Color needs no sync, just regen
      document
        .getElementById("petalColor")
        .addEventListener("input", generateFlower);

      // Hide/Show Logic
      const uiPanel = document.getElementById("ui-container");
      const hideBtn = document.getElementById("hide-ui-btn");
      const showBtn = document.getElementById("show-ui-btn");

      hideBtn.addEventListener("click", () => {
        uiPanel.classList.add("hidden"); // Slide out
      });

      showBtn.addEventListener("click", () => {
        uiPanel.classList.remove("hidden"); // Slide in
      });

      // --- SNAPSHOT LOGIC ---
      document.getElementById("saveBtn").addEventListener("click", async () => {
        renderer.render(scene, camera);
        const dataURL = renderer.domElement.toDataURL("image/png");

        if (navigator.share) {
          const blob = await (await fetch(dataURL)).blob();
          const file = new File([blob], "waania-rose.png", {
            type: "image/png",
          });
          try {
            await navigator.share({ files: [file], title: "My Flower" });
          } catch (e) {}
        } else {
          const link = document.createElement("a");
          link.download = "flower.png";
          link.href = dataURL;
          link.click();
        }
      });

      // Init
      generateFlower();
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
