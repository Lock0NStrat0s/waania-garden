<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Waania's Botanical Lab</title>
    <style>
      /* --- BASE STYLES --- */
      body {
        margin: 0;
        overflow: hidden;
        background: #050510;
        font-family: system-ui, -apple-system, sans-serif;
      }
      canvas {
        display: block;
      }

      /* --- UI CONTAINER (The Shell) --- */
      #ui-container {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 300px;
        max-width: 90%;
        max-height: 50vh;

        background: rgba(20, 20, 35, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);

        /* Layout: Header is fixed, content scrolls */
        display: flex;
        flex-direction: column;
        z-index: 20;
        transition: opacity 0.3s;
      }
      #ui-container.hidden {
        opacity: 0;
        pointer-events: none;
      }

      /* --- HEADER (Fixed at top) --- */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 20px 20px 10px 20px; /* Internal padding */
        flex-shrink: 0; /* Never shrink */
      }
      h1 {
        margin: 0;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.9);
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 800;
      }
      .close-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px;
      }

      /* --- SCROLLABLE CONTENT --- */
      .scroll-content {
        overflow-y: auto;
        padding: 15px 20px 20px 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      /* Custom Scrollbar */
      .scroll-content::-webkit-scrollbar {
        width: 4px;
      }
      .scroll-content::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
      }

      /* --- OPEN BUTTON --- */
      #show-ui-btn {
        position: absolute;
        bottom: 25px;
        left: 25px;
        background: rgba(20, 20, 35, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 5;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.3s;
      }
      #show-ui-btn.hidden {
        opacity: 0;
        pointer-events: none;
      }

      /* --- INPUTS --- */
      .control-row {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .label-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #aaa;
        font-weight: 500;
      }
      .input-group {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      input[type="range"] {
        flex-grow: 1;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        -webkit-appearance: none;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        background: #ff0066;
        border-radius: 50%;
        margin-top: -5px;
        box-shadow: 0 0 10px rgba(255, 0, 102, 0.5);
      }
      input[type="number"] {
        width: 45px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        color: white;
        padding: 6px;
        text-align: center;
      }
      input[type="color"] {
        width: 100%;
        height: 40px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: none;
      }

      .action-btn {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
      }
      #mutateBtn {
        background: linear-gradient(
          135deg,
          rgba(255, 0, 102, 0.1),
          rgba(255, 0, 102, 0.2)
        );
        border: 1px solid rgba(255, 0, 102, 0.3);
        color: #ff3388;
        margin-bottom: 10px;
      }
      #breatheBtn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ddd;
      }
      #breatheBtn.active {
        background: rgba(0, 255, 128, 0.15);
        border-color: rgba(0, 255, 128, 0.4);
        color: #00ff80;
      }

      /* --- ACTION BAR (Top Right on Mobile) --- */
      .action-bar {
        position: absolute;
        bottom: 25px;
        right: 25px;
        display: flex;
        gap: 15px;
        z-index: 100;
        transition: opacity 0.3s;
      }
      .action-bar.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .fab-btn {
        border: none;
        padding: 0 24px;
        height: 48px;
        border-radius: 50px;
        font-weight: 800;
        font-size: 0.9rem;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .fab-btn:active {
        transform: scale(0.95);
      }
      #studioBtn {
        background: #ff0066;
        color: white;
      }
      #saveBtn {
        background: white;
        color: #1a1a2e;
      }

      /* --- STUDIO OVERLAY --- */
      #studio-msg {
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: rgba(255, 255, 255, 0.8);
        font-weight: 600;
        background: rgba(0, 0, 0, 0.6);
        padding: 12px 24px;
        border-radius: 30px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 1s ease-out;
        text-align: center;
        width: max-content;
      }

      /* --- MOBILE LAYOUT --- */
      @media (max-width: 600px) {
        .action-bar {
          bottom: auto;
          top: 20px;
          right: 20px;
        }
        #ui-container {
          left: 50%;
          transform: translateX(-50%);
          bottom: 20px;
          width: 90%;
          max-height: 45vh;
        }
        #ui-container.hidden {
          opacity: 0;
          pointer-events: none;
        }
      }
    </style>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>
  </head>
  <body>
    <div id="studio-msg">Tap anywhere to exit Studio Mode</div>

    <button id="show-ui-btn" title="Open Controls">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <line x1="4" y1="21" x2="4" y2="14"></line>
        <line x1="4" y1="10" x2="4" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12" y2="3"></line>
        <line x1="20" y1="21" x2="20" y2="16"></line>
        <line x1="20" y1="12" x2="20" y2="3"></line>
        <line x1="1" y1="14" x2="7" y2="14"></line>
        <line x1="9" y1="8" x2="15" y2="8"></line>
        <line x1="17" y1="16" x2="23" y2="16"></line>
      </svg>
    </button>

    <div id="ui-container">
      <div class="header">
        <h1>Botanical Lab</h1>
        <button class="close-btn" id="hide-ui-btn">‚úï</button>
      </div>

      <div class="scroll-content">
        <button id="mutateBtn" class="action-btn">üé≤ Mutate DNA</button>

        <div class="control-row">
          <div class="label-row"><label>Petal Count</label></div>
          <div class="input-group">
            <input
              type="range"
              id="petalCount"
              min="3"
              max="50"
              value="12"
            /><input type="number" id="petalCountNum" value="12" />
          </div>
        </div>
        <div class="control-row">
          <div class="label-row"><label>Bloom Stage</label></div>
          <div class="input-group">
            <input
              type="range"
              id="bloomRadius"
              min="0"
              max="1.5"
              step="0.1"
              value="0.5"
            /><input type="number" id="bloomRadiusNum" value="0.5" step="0.1" />
          </div>
        </div>
        <div class="control-row">
          <div class="label-row"><label>Petal Length</label></div>
          <div class="input-group">
            <input
              type="range"
              id="petalLength"
              min="1"
              max="8"
              step="0.1"
              value="4"
            /><input type="number" id="petalLengthNum" value="4" step="0.1" />
          </div>
        </div>
        <div class="control-row">
          <div class="label-row"><label>Petal Width</label></div>
          <div class="input-group">
            <input
              type="range"
              id="petalWidth"
              min="0.1"
              max="2"
              step="0.1"
              value="1"
            /><input type="number" id="petalWidthNum" value="1" step="0.1" />
          </div>
        </div>
        <div class="control-row">
          <div class="label-row"><label>Pigment</label></div>
          <input type="color" id="petalColor" value="#ff0066" />
        </div>
        <div class="control-row">
          <div class="label-row"><label>Animation</label></div>
          <button id="breatheBtn" class="action-btn">Start Breathing</button>
        </div>
      </div>
    </div>

    <div class="action-bar">
      <button id="studioBtn" class="fab-btn">üëÅÔ∏è Studio</button>
      <button id="saveBtn" class="fab-btn">üì∏ Snap</button>
    </div>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";
      import { EffectComposer } from "three/addons/postprocessing/EffectComposer.js";
      import { RenderPass } from "three/addons/postprocessing/RenderPass.js";
      import { UnrealBloomPass } from "three/addons/postprocessing/UnrealBloomPass.js";

      // --- 1. AUDIO ---
      let audioCtx,
        osc1,
        osc2,
        gainNode,
        isAudioInit = false;
      function initAudio() {
        if (isAudioInit) return;
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        gainNode = audioCtx.createGain();
        gainNode.gain.value = 0;
        gainNode.connect(audioCtx.destination);
        osc1 = audioCtx.createOscillator();
        osc1.frequency.value = 110;
        osc1.connect(gainNode);
        osc1.start();
        osc2 = audioCtx.createOscillator();
        osc2.frequency.value = 112;
        osc2.connect(gainNode);
        osc2.start();
        isAudioInit = true;
      }
      function toggleAudio(isPlaying) {
        if (!isAudioInit) initAudio();
        if (audioCtx.state === "suspended") audioCtx.resume();
        const now = audioCtx.currentTime;
        gainNode.gain.cancelScheduledValues(now);
        gainNode.gain.linearRampToValueAtTime(
          isPlaying ? 0.05 : 0,
          now + (isPlaying ? 1 : 0.5)
        );
      }

      // --- 2. ASSETS ---
      function createVeinTexture() {
        const size = 512;
        const canvas = document.createElement("canvas");
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, size, size);
        ctx.strokeStyle = "#999999";
        ctx.lineWidth = 2;
        ctx.globalAlpha = 0.3;
        for (let i = 0; i < 40; i++) {
          const startX = Math.random() * size;
          ctx.beginPath();
          ctx.moveTo(startX, 0);
          ctx.bezierCurveTo(
            startX + (Math.random() * 100 - 50),
            size / 3,
            startX + (Math.random() * 100 - 50),
            (size * 2) / 3,
            startX,
            size
          );
          ctx.stroke();
        }
        return new THREE.CanvasTexture(canvas);
      }
      function createParticles() {
        const count = 300;
        const geometry = new THREE.BufferGeometry();
        const pos = [],
          vel = [];
        for (let i = 0; i < count; i++) {
          pos.push(
            (Math.random() - 0.5) * 25,
            (Math.random() - 0.5) * 25,
            (Math.random() - 0.5) * 25
          );
          vel.push(
            (Math.random() - 0.5) * 0.015,
            (Math.random() - 0.5) * 0.015,
            (Math.random() - 0.5) * 0.015
          );
        }
        geometry.setAttribute(
          "position",
          new THREE.Float32BufferAttribute(pos, 3)
        );
        geometry.userData = { velocities: vel };
        return new THREE.Points(
          geometry,
          new THREE.PointsMaterial({
            color: 0xffffff,
            size: 0.15,
            transparent: true,
            opacity: 0.8,
            sizeAttenuation: true,
          })
        );
      }

      // --- 3. SCENE ---
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x050510);
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      camera.position.set(0, 5, 15);
      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        preserveDrawingBuffer: true,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.toneMapping = THREE.ReinhardToneMapping;
      document.body.appendChild(renderer.domElement);

      const composer = new EffectComposer(renderer);
      composer.addPass(new RenderPass(scene, camera));
      const bloomPass = new UnrealBloomPass(
        new THREE.Vector2(window.innerWidth, window.innerHeight),
        1.5,
        0.4,
        0.85
      );
      bloomPass.strength = 0.5;
      bloomPass.radius = 0.5;
      bloomPass.threshold = 0.1;
      composer.addPass(bloomPass);

      scene.add(new THREE.AmbientLight(0xffffff, 0.2));
      const pl = new THREE.PointLight(0xffffff, 1.2, 100);
      pl.position.set(10, 10, 10);
      scene.add(pl);
      const bl = new THREE.PointLight(0xff0066, 1.0, 100);
      bl.position.set(-10, 5, -10);
      scene.add(bl);
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.autoRotate = false;

      // --- 4. OBJECTS ---
      const flowerGroup = new THREE.Group();
      flowerGroup.position.y = 2;
      scene.add(flowerGroup);
      const particles = createParticles();
      scene.add(particles);
      const stemGroup = new THREE.Group(),
        petalGroup = new THREE.Group();
      flowerGroup.add(stemGroup);
      flowerGroup.add(petalGroup);

      const petalGeo = new THREE.SphereGeometry(0.5, 32, 16);
      petalGeo.translate(0, 0.5, 0);
      const thornGeo = new THREE.ConeGeometry(0.08, 0.4, 8);
      thornGeo.translate(0, 0.2, 0);
      const stemPath = new THREE.CatmullRomCurve3([
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(0.5, -4, 0),
        new THREE.Vector3(0, -8, 0),
      ]);
      const stemGeo = new THREE.TubeGeometry(stemPath, 20, 0.15, 8, false);
      const veinTex = createVeinTexture();
      const baseMat = new THREE.MeshPhongMaterial({
        shininess: 30,
        side: THREE.DoubleSide,
        map: veinTex,
        bumpMap: veinTex,
        bumpScale: 0.05,
        emissive: 0x000000,
        specular: 0x222222,
      });
      const stemMat = new THREE.MeshPhongMaterial({
        color: 0x339933,
        shininess: 5,
        flatShading: true,
      });

      function generateStem() {
        stemGroup.clear();
        stemGroup.add(new THREE.Mesh(stemGeo, stemMat));
        for (let i = 0; i < 3; i++) {
          const p = new THREE.Object3D();
          p.rotation.z = (i / 3) * (Math.PI * 2);
          const s = new THREE.Mesh(petalGeo, stemMat);
          s.scale.set(0.6, 4, 0.1);
          s.rotation.x = -2.0;
          s.position.y = -0.2;
          p.add(s);
          stemGroup.add(p);
        }
        for (let i = 1; i < 20 - 1; i++) {
          const t = i / 20;
          const pt = stemPath.getPointAt(t);
          const tan = stemPath.getTangentAt(t);
          if (Math.random() < 0.2) {
            const th = new THREE.Mesh(thornGeo, stemMat);
            th.position.copy(pt);
            th.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), tan);
            th.rotateX(Math.PI / 2);
            th.rotateZ(Math.random() * Math.PI * 2);
            stemGroup.add(th);
          }
          if (t > 0.3 && Math.random() < 0.15) {
            const lf = new THREE.Mesh(petalGeo, stemMat);
            lf.scale.set(0.5, 1.5, 0.05);
            lf.position.copy(pt);
            lf.quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), tan);
            lf.rotateX(Math.PI / 2);
            lf.rotateZ(Math.random() * Math.PI * 2);
            stemGroup.add(lf);
          }
        }
      }
      function generatePetals() {
        petalGroup.clear();
        const count = parseInt(document.getElementById("petalCount").value);
        const bloom = parseFloat(document.getElementById("bloomRadius").value);
        const len = parseFloat(document.getElementById("petalLength").value);
        const wid = parseFloat(document.getElementById("petalWidth").value);
        const colorVal = document.getElementById("petalColor").value;
        for (let i = 0; i < count; i++) {
          for (let r = 0; r < 4; r++) {
            const pivot = new THREE.Object3D();
            pivot.rotation.z = (i / count) * (Math.PI * 2) + r * 0.5;
            const mat = baseMat.clone();
            const col = new THREE.Color(colorVal);
            const hsl = {};
            col.getHSL(hsl);
            mat.color.setHSL(hsl.h, hsl.s, hsl.l + (r * 0.1 - 0.1));
            if (r < 2) mat.emissive.setHSL(hsl.h, hsl.s, hsl.l * 0.1);
            const petal = new THREE.Mesh(petalGeo, mat);
            petal.rotation.x = bloom + r * 0.3;
            const scale = 1 - r * 0.25;
            petal.scale.set(scale * wid, scale * len, scale * 0.1);
            pivot.add(petal);
            petalGroup.add(pivot);
          }
        }
      }

      // --- 5. LOGIC ---
      function updateInput(id, val) {
        const el = document.getElementById(id);
        if (el) el.value = val;
      }
      function bindInput(sliderId, numId) {
        const s = document.getElementById(sliderId),
          n = document.getElementById(numId);
        s.addEventListener("input", () => {
          n.value = s.value;
          generatePetals();
          saveState();
        });
        n.addEventListener("input", () => {
          s.value = n.value;
          generatePetals();
          saveState();
        });
      }
      bindInput("petalCount", "petalCountNum");
      bindInput("bloomRadius", "bloomRadiusNum");
      bindInput("petalLength", "petalLengthNum");
      bindInput("petalWidth", "petalWidthNum");
      document.getElementById("petalColor").addEventListener("input", () => {
        generatePetals();
        saveState();
      });

      const ui = document.getElementById("ui-container");
      const openBtn = document.getElementById("show-ui-btn");
      const actionbar = document.querySelector(".action-bar");
      const studioMsg = document.getElementById("studio-msg");

      document
        .getElementById("hide-ui-btn")
        .addEventListener("click", () => ui.classList.add("hidden"));
      openBtn.addEventListener("click", () => ui.classList.remove("hidden"));

      document.getElementById("mutateBtn").addEventListener("click", () => {
        const rCount = Math.floor(Math.random() * 45) + 5;
        const rColor = new THREE.Color().setHSL(
          Math.random(),
          0.5 + Math.random() * 0.5,
          0.4 + Math.random() * 0.2
        );
        updateInput("petalCount", rCount);
        updateInput("petalCountNum", rCount);
        updateInput("bloomRadius", (Math.random() * 1.5).toFixed(1));
        updateInput(
          "bloomRadiusNum",
          document.getElementById("bloomRadius").value
        );
        updateInput("petalLength", (Math.random() * 5 + 2).toFixed(1));
        updateInput(
          "petalLengthNum",
          document.getElementById("petalLength").value
        );
        updateInput("petalWidth", (Math.random() * 1.9 + 0.1).toFixed(1));
        updateInput(
          "petalWidthNum",
          document.getElementById("petalWidth").value
        );
        document.getElementById("petalColor").value =
          "#" + rColor.getHexString();
        generatePetals();
        saveState();
      });

      let isBreathing = false,
        breatheTime = 0;
      const breatheBtn = document.getElementById("breatheBtn");
      breatheBtn.addEventListener("click", () => {
        isBreathing = !isBreathing;
        breatheBtn.classList.toggle("active");
        breatheBtn.innerText = isBreathing
          ? "Stop Breathing"
          : "Start Breathing";
        toggleAudio(isBreathing);
      });
      function updateBreathing() {
        if (!isBreathing) return;
        breatheTime += 0.02;
        const val = 0.5 + Math.sin(breatheTime) * 0.3;
        document.getElementById("bloomRadius").value = val;
        document.getElementById("bloomRadiusNum").value = val.toFixed(2);
        generatePetals();
      }

      // --- STUDIO MODE ---
      let studioMode = false;
      document.getElementById("studioBtn").addEventListener("click", (e) => {
        e.stopPropagation();
        studioMode = true;
        ui.classList.add("hidden");
        actionbar.classList.add("hidden");
        openBtn.classList.add("hidden");
        // Show Msg then fade
        studioMsg.style.opacity = "1";
        setTimeout(() => (studioMsg.style.opacity = "0"), 3000); // Fade out after 3s
      });

      function exitStudio() {
        if (studioMode) {
          studioMode = false;
          ui.classList.remove("hidden");
          actionbar.classList.remove("hidden");
          openBtn.classList.remove("hidden");
          studioMsg.style.opacity = "0";
        }
      }
      // Listener for both click and touch to ensure mobile exit works
      window.addEventListener("click", exitStudio);
      window.addEventListener("touchstart", exitStudio);

      // --- SNAP BUTTON ---
      document
        .getElementById("saveBtn")
        .addEventListener("click", async (e) => {
          e.stopPropagation();
          composer.render();
          const dataURL = renderer.domElement.toDataURL("image/png");
          const isMobile =
            /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ||
            window.innerWidth < 800;

          if (isMobile && navigator.share) {
            const blob = await (await fetch(dataURL)).blob();
            const file = new File([blob], "waania-flower.png", {
              type: "image/png",
            });
            try {
              await navigator.share({ files: [file], title: "My Flower" });
            } catch (e) {}
          } else {
            const link = document.createElement("a");
            link.download = "waania-flower.png";
            link.href = dataURL;
            link.click();
          }
        });

      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        composer.setSize(window.innerWidth, window.innerHeight);
      });

      function saveState() {
        const state = {
          count: document.getElementById("petalCount").value,
          bloom: document.getElementById("bloomRadius").value,
          length: document.getElementById("petalLength").value,
          width: document.getElementById("petalWidth").value,
          color: document.getElementById("petalColor").value,
        };
        localStorage.setItem("waania-flower-state", JSON.stringify(state));
      }
      function loadState() {
        const state = JSON.parse(localStorage.getItem("waania-flower-state"));
        if (state) {
          updateInput("petalCount", state.count);
          updateInput("petalCountNum", state.count);
          updateInput("bloomRadius", state.bloom);
          updateInput("bloomRadiusNum", state.bloom);
          updateInput("petalLength", state.length);
          updateInput("petalLengthNum", state.length);
          updateInput("petalWidth", state.width);
          updateInput("petalWidthNum", state.width);
          document.getElementById("petalColor").value = state.color;
          generatePetals();
        }
      }

      generateStem();
      localStorage.getItem("waania-flower-state")
        ? loadState()
        : generatePetals();

      function animate() {
        requestAnimationFrame(animate);
        updateBreathing();
        controls.update();
        const pos = particles.geometry.attributes.position.array;
        const vel = particles.geometry.userData.velocities;
        for (let i = 0; i < pos.length; i += 3) {
          pos[i] += vel[i];
          pos[i + 1] += vel[i + 1];
          pos[i + 2] += vel[i + 2];
          if (pos[i] > 15) pos[i] = -15;
          if (pos[i] < -15) pos[i] = 15;
          if (pos[i + 1] > 15) pos[i + 1] = -15;
          if (pos[i + 1] < -15) pos[i + 1] = 15;
          if (pos[i + 2] > 15) pos[i + 2] = -15;
          if (pos[i + 2] < -15) pos[i + 2] = 15;
        }
        particles.geometry.attributes.position.needsUpdate = true;
        composer.render();
      }
      animate();
    </script>
  </body>
</html>
